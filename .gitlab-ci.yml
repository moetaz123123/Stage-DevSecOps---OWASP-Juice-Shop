variables:
  IMAGE_NAME: tayeb517/juice-shop
  IMAGE_TAG: juice-shop-1.2

stages:
  - cache
  - sast
  - build
  - scan  # Nouveau stage pour Trivy
  
create_cache:
  image: node:18-bullseye
  stage: cache
  script:
    - rm -rf node_modules yarn.lock
    - yarn install --ignore-engines
  cache:
    key:
      files:
        - package.json
    paths:
      - node_modules/
      - yarn.lock
      - .yarn
    policy: pull-push

sonarqube_sast:
  stage: sast
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  cache:
    key: "sonar"
    paths:
      - .sonar/cache
  script:
    - echo "Using SONAR_TOKEN from GitLab CI variables"
    - sonar-scanner 
        -Dsonar.host.url="$SONAR_HOST_URL" 
        -Dsonar.token="$SONAR_TOKEN" 
        -Dsonar.projectKey="azizdaoues19_juice-shop" 
        -Dsonar.organization="azizdaoues19"
  artifacts:
    paths:
      - .scannerwork/
    expire_in: 7 days
  only:
    - branches
    - merge_requests

semgrep_sast:
  stage: sast
  image: returntocorp/semgrep
  script:
    - semgrep --config=auto --json --output=semgrep-report.json . || true
    - semgrep --config=auto --severity=ERROR --severity=WARNING .
  artifacts:
    paths:
      - semgrep-report.json
    expire_in: 7 days
    reports:
      sast: semgrep-report.json
  allow_failure: true

npm_audit:
  stage: sast
  image: node:18-bullseye
  script:
    - yarn install --ignore-engines
    - echo "Running npm audit..."
    - npm audit --json > npm-audit-report.json || true
    - npm audit --audit-level=moderate || true
  artifacts:
    paths:
      - npm-audit-report.json
    expire_in: 7 days
  cache:
    key:
      files:
        - package.json
    paths:
      - node_modules/
    policy: pull
  allow_failure: true

build_image:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
  script:
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker push $IMAGE_NAME:$IMAGE_TAG
  artifacts:
    expire_in: 1 day
    reports:
      dotenv: build.env
  after_script:
    - echo "BUILT_IMAGE=$IMAGE_NAME:$IMAGE_TAG" > build.env

# Nouveau job Trivy pour scanner l'image Docker
trivy_scan:
  stage: scan
  image: 
    name: aquasec/trivy:latest
    entrypoint: [""]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  services:
    - docker:24-dind
  before_script:
    - echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
  script:
    # Pull l'image depuis Docker Hub
    - docker pull $IMAGE_NAME:$IMAGE_TAG
    
    # Scan de vuln√©rabilit√©s (format table pour console)
    - echo "üîç Scanning image for vulnerabilities..."
    - trivy image --severity HIGH,CRITICAL $IMAGE_NAME:$IMAGE_TAG
    
    # G√©n√©ration des rapports
    - trivy image --format json --output trivy-report.json $IMAGE_NAME:$IMAGE_TAG
    - trivy image --format sarif --output trivy-report.sarif $IMAGE_NAME:$IMAGE_TAG
    
    # Scan avec exit code (fail si vuln√©rabilit√©s critiques)
    - trivy image --exit-code 0 --severity HIGH,CRITICAL $IMAGE_NAME:$IMAGE_TAG
  artifacts:
    paths:
      - trivy-report.json
      - trivy-report.sarif
    expire_in: 30 days
    reports:
      container_scanning: trivy-report.json
  dependencies:
    - build_image
  allow_failure: true  # Ne bloque pas le pipeline m√™me si des vuln√©rabilit√©s sont trouv√©es