variables: 
  IMAGE_NAME: tayeb517/juice-shop 
  IMAGE_TAG: juice-shop-1.1 
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  GIT_DEPTH: "0"
  NODE_OPTIONS: "--max_old_space_size=4096"
 
stages: 
  - test 
  - quality 
  - build 
 
# --------- 1) TESTS API (JUICE SHOP) --------- 
yarn_test: 
  image: node:18-bullseye 
  stage: test 
  before_script:
    # Installation minimale (backend uniquement)
    - npm install --legacy-peer-deps --ignore-scripts
    # Installation manuelle de nyc, jest et la config TypeScript pour nyc
    - npm list nyc || npm install --no-save nyc@15.1.0 @istanbuljs/nyc-config-typescript
    - npm list jest || npm install --no-save jest@26.6.3
    - npm list ts-jest || npm install --no-save ts-jest@26.5.0
  script: 
    # Exécuter les tests avec nyc
    - npx nyc --report-dir=./coverage --reporter=lcov --reporter=text-summary --reporter=cobertura jest --silent --runInBand --forceExit --ci
  cache: 
    key: 
      files: 
        - package-lock.json
    paths: 
      - node_modules/
    policy: pull-push
  artifacts: 
    paths: 
      - coverage/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    expire_in: 1 day
    when: always
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  retry:
    max: 2
    when: script_failure
 
# --------- 2) TESTS DE SÉCURITÉ --------- 
gitleaks: 
  stage: test 
  image: 
    name: zricethezav/gitleaks:latest
    entrypoint: [""] 
  script: 
    - gitleaks detect --verbose --source . -f json -r gitleaks-report.json || true
  artifacts:
    paths:
      - gitleaks-report.json
    expire_in: 1 week
    when: always
  allow_failure: true 
 
njsscan: 
  stage: test 
  image: python:3.11-slim
  before_script: 
    - pip install --no-cache-dir "njsscan==0.4.3"
  script: 
    - njsscan --exit-warning . --sarif -o njsscan-report.sarif || true
  artifacts:
    paths:
      - njsscan-report.sarif
    expire_in: 1 week
    when: always
  allow_failure: true 
 
semgrep: 
  stage: test 
  image: semgrep/semgrep:latest
  variables: 
    SEMGREP_RULES: p/javascript
  script: 
    - semgrep ci --config=auto --sarif -o semgrep-report.sarif || true
  artifacts:
    paths:
      - semgrep-report.sarif
    expire_in: 1 week
    when: always
  allow_failure: true 
 
# --------- 3) SONARCLOUD --------- 
sonarcloud: 
  stage: quality 
  image: 
    name: sonarsource/sonar-scanner-cli:latest 
    entrypoint: [""] 
  script: 
    - sonar-scanner
      -Dsonar.projectKey=${SONAR_PROJECT_KEY}
      -Dsonar.organization=${SONAR_ORGANIZATION}
      -Dsonar.sources=lib,models,routes,server.ts
      -Dsonar.exclusions=**/node_modules/**,**/test/**,**/tests/**,**/*.spec.ts,**/*.test.ts,**/coverage/**,**/build/**,**/frontend/**,**/data/**,**/ftp/**,**/logs/**
      -Dsonar.tests=test
      -Dsonar.test.inclusions=**/test/api/*Spec.ts
      -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
      -Dsonar.typescript.lcov.reportPaths=coverage/lcov.info
  cache: 
    key: "${CI_JOB_NAME}" 
    paths: 
      - .sonar/cache 
  dependencies: 
    - yarn_test
  needs:
    - yarn_test
  only:
    - main
    - develop
    - merge_requests
  allow_failure: false
 
# --------- 4) BUILD & PUSH DOCKER --------- 
build_image: 
  stage: build 
  image: docker:24-alpine
  services: 
    - docker:24-dind 
  variables: 
    DOCKER_PASS: $DOCKER_PASS 
    DOCKER_USER: $DOCKER_USER
    DOCKER_TLS_CERTDIR: "/certs"
  before_script: 
    - echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin 
  script: 
    - docker build --no-cache -t $IMAGE_NAME:$IMAGE_TAG . 
    - docker push $IMAGE_NAME:$IMAGE_TAG
    - docker tag $IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:latest
    - docker push $IMAGE_NAME:latest
  only:
    - main
    - tags
  when: manual