variables:
  IMAGE_NAME: tayeb517/juice-shop
  IMAGE_TAG: juice-shop-1.1
  APP_PORT: 3000  # Port interne de Juice Shop

stages:
  - cache
  - sast
  - build
  - scan
  - dast
  
create_cache:
  image: node:18-bullseye
  stage: cache
  script:
    - rm -rf node_modules yarn.lock
    - yarn install --ignore-engines
  cache:
    key:
      files:
        - package.json
    paths:
      - node_modules/
      - yarn.lock
      - .yarn
    policy: pull-push

sonarqube_sast:
  stage: sast
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  cache:
    key: "sonar"
    paths:
      - .sonar/cache
  script:
    - echo "Using SONAR_TOKEN from GitLab CI variables"
    - sonar-scanner 
        -Dsonar.host.url="$SONAR_HOST_URL" 
        -Dsonar.token="$SONAR_TOKEN" 
        -Dsonar.projectKey="azizdaoues19_juice-shop" 
        -Dsonar.organization="azizdaoues19"
  artifacts:
    paths:
      - .scannerwork/
    expire_in: 7 days
  only:
    - branches
    - merge_requests

semgrep_sast:
  stage: sast
  image: returntocorp/semgrep
  script:
    - semgrep --config=auto --json --output=semgrep-report.json . || true
    - semgrep --config=auto --severity=ERROR --severity=WARNING .
  artifacts:
    paths:
      - semgrep-report.json
    expire_in: 7 days
    reports:
      sast: semgrep-report.json
  allow_failure: true

npm_audit:
  stage: sast
  image: node:18-bullseye
  script:
    - yarn install --ignore-engines
    - echo "Running npm audit..."
    - npm audit --json > npm-audit-report.json || true
    - npm audit --audit-level=moderate || true
  artifacts:
    paths:
      - npm-audit-report.json
    expire_in: 7 days
  cache:
    key:
      files:
        - package.json
    paths:
      - node_modules/
    policy: pull
  allow_failure: true

build_image:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
  script:
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker push $IMAGE_NAME:$IMAGE_TAG
    - echo "BUILT_IMAGE=$IMAGE_NAME:$IMAGE_TAG" > build.env
  artifacts:
    expire_in: 1 day
    reports:
      dotenv: build.env

trivy_scan:
  stage: scan
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add curl
    - docker login -u $DOCKER_USER -p $DOCKER_PASS
  script:
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
    - trivy image --no-progress --severity HIGH,CRITICAL --output trivy-scanning-report.txt $IMAGE_NAME:$IMAGE_TAG
  artifacts:
    reports:
      container_scanning: trivy-scanning-report.txt
  dependencies:
    - build_image
  allow_failure: true

zap_dast:
  stage: dast
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache curl
    - docker login -u $DOCKER_USER -p $DOCKER_PASS
  script:
    - echo "Pulling Juice Shop image..."
    - docker pull $IMAGE_NAME:$IMAGE_TAG
    - echo "Starting Juice Shop application..."
    - docker run -d --name juice-shop-zap -p 3000:3000 $IMAGE_NAME:$IMAGE_TAG
    - echo "Waiting for application to start..."
    - sleep 45
    - echo "Checking if application is running..."
    - docker ps | grep juice-shop-zap
    - docker logs juice-shop-zap
    - echo "Testing application connectivity..."
    - docker exec juice-shop-zap wget -O- http://localhost:3000 || echo "App not ready yet"
    - echo "Getting container IP..."
    - CONTAINER_IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' juice-shop-zap)
    - echo "Container IP is $CONTAINER_IP"
    - echo "Running OWASP ZAP scan..."
    - docker run --rm --link juice-shop-zap:target -v $(pwd):/zap/wrk:rw ghcr.io/zaproxy/zaproxy:stable zap-baseline.py -t http://target:3000 -r zap-report.html -J zap-report.json -I || true
    - ls -la zap-report.* || echo "No ZAP reports found"
  after_script:
    - docker logs juice-shop-zap || true
    - docker stop juice-shop-zap || true
    - docker rm juice-shop-zap || true
  artifacts:
    when: always
    paths:
      - zap-report.html
      - zap-report.json
    expire_in: 7 days
  allow_failure: true
  needs:
    - build_image

nikto_dast:
  stage: dast
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache curl perl
    - docker login -u $DOCKER_USER -p $DOCKER_PASS
  script:
    - echo "Pulling Juice Shop image..."
    - docker pull $IMAGE_NAME:$IMAGE_TAG
    - echo "Starting Juice Shop application for Nikto scan..."
    - docker run -d --name juice-shop-nikto -p 3001:3000 $IMAGE_NAME:$IMAGE_TAG
    - echo "Waiting for application to start..."
    - sleep 45
    - echo "Checking if application is running..."
    - docker ps | grep juice-shop-nikto
    - docker logs juice-shop-nikto
    - echo "Getting container IP..."
    - CONTAINER_IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' juice-shop-nikto)
    - echo "Container IP is $CONTAINER_IP"
    - echo "Running Nikto web vulnerability scan..."
    - docker run --rm --link juice-shop-nikto:target -v $(pwd):/tmp secfigo/nikto:latest -h http://target:3000 -Format htm -output /tmp/nikto-report.html || true
    - docker run --rm --link juice-shop-nikto:target -v $(pwd):/tmp secfigo/nikto:latest -h http://target:3000 -Format json -output /tmp/nikto-report.json || true
    - ls -la nikto-report.* || echo "No Nikto reports found"
    - echo "Nikto scan completed"
  after_script:
    - docker logs juice-shop-nikto || true
    - docker stop juice-shop-nikto || true
    - docker rm juice-shop-nikto || true
  artifacts:
    when: always
    paths:
      - nikto-report.html
      - nikto-report.json
    expire_in: 7 days
  allow_failure: true
  needs:
    - build_image

nuclei_dast:
  stage: dast
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache curl
    - docker login -u $DOCKER_USER -p $DOCKER_PASS
  script:
    - echo "Pulling Juice Shop image..."
    - docker pull $IMAGE_NAME:$IMAGE_TAG
    - echo "Starting Juice Shop application for Nuclei scan..."
    - docker run -d --name juice-shop-nuclei -p 3002:3000 $IMAGE_NAME:$IMAGE_TAG
    - echo "Waiting for application to start..."
    - sleep 45
    - echo "Checking if application is running..."
    - docker ps | grep juice-shop-nuclei
    - docker logs juice-shop-nuclei
    - echo "Getting container IP..."
    - CONTAINER_IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' juice-shop-nuclei)
    - echo "Container IP is $CONTAINER_IP"
    - echo "Running Nuclei vulnerability scanner..."
    - docker run --rm --link juice-shop-nuclei:target -v $(pwd):/output projectdiscovery/nuclei:latest -u http://target:3000 -jsonl -o /output/nuclei-report.jsonl || true
    - docker run --rm --link juice-shop-nuclei:target -v $(pwd):/output projectdiscovery/nuclei:latest -u http://target:3000 -markdown-export /output/nuclei-report.md || true
    - ls -la nuclei-report.* || echo "No Nuclei reports found"
    - echo "Nuclei scan completed"
  after_script:
    - docker logs juice-shop-nuclei || true
    - docker stop juice-shop-nuclei || true
    - docker rm juice-shop-nuclei || true
  artifacts:
    when: always
    paths:
      - nuclei-report.jsonl
      - nuclei-report.md
    expire_in: 7 days
  allow_failure: true
  needs:
    - build_image